#/bin/bash

usage() {
	echo "A simple Task Manager
usage:
	$0 OPTION
	OPTION is:
	-n	task's name
	-d	task's descripton
	-v	verbose mode
	-l	Limit item
	-u	view Unfinished task
	-i	view fInished task
	-a	view All task
	-f	task is done
	-c	Cancel a task
	-h	help
Power by <http://sqlite.org>"
	exit;
}

# define database name
db='tasks.db3'
# if database isn't esit, cretate it
if [[ ! -f ~/$db ]]; then
	sqlite3 ~/$db "
	CREATE TABLE status (
		id INTEGER PRIMARY KEY AUTOINCREMENT,
		name TEXT NOT NULL,
		comment TEXT NULL
	);
	CREATE TABLE tasks (
		id INTEGER PRIMARY KEY AUTOINCREMENT,
		name TEXT NOT NULL,
		comment TEXT NOT NULL,
		status INTEGER REFERENCES status(id) DEFAULT 0,
		start TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
		end TIMESTAMP DEFAULT 0
	);"
	exit
fi

if [[ "$#" -lt "1" ]]; then
	usage
fi

limit=50;

while getopts "vn:d:l:uiaf:c:h" opt; do
  case $opt in
  
    v)
     verbose=1
     ;;
    n)
      name="$OPTARG"
      ;;
    d)
      des="$OPTARG"
      ;;
    l)
      limit=$OPTARG
      ;;
    u)
      if [[ $verbose -eq 1 ]]; then
      	sqlite3 -line ~/$db "SELECT T.id,T.name,T.comment,datetime(start,'localtime') AS start FROM tasks AS T INNER JOIN status AS S ON T.status = S.id WHERE status=0 AND end=0 LIMIT $limit;" | more
      else
      	sqlite3 ~/$db "SELECT id, name FROM tasks WHERE status=0 AND end=0 LIMIT $limit;" | more
      fi
      ;;
    i)
      sqlite3 -line ~/$db "SELECT T.id,T.name,T.comment,datetime(start,'localtime') AS start ,datetime(end,'localtime') AS end FROM tasks AS T INNER JOIN status AS S ON T.status = S.id WHERE status=1 ORDER BY end LIMIT $limit;" | more
      ;;
    a)
      sqlite3 ~/$db "SELECT T.id,T.name,T.comment,S.name AS status,start,end FROM tasks AS T INNER JOIN status AS S ON T.status = S.id LIMIT $limit;" | more
      ;;
    f)
      sqlite3 -line ~/$db "UPDATE tasks SET status=1 , end=CURRENT_TIMESTAMP WHERE id = '$OPTARG' AND end=0; SELECT * FROM tasks WHERE id = '$OPTARG';"
      ;;
    c)
      sqlite3 -line ~/$db "UPDATE tasks SET status=2 , end=CURRENT_TIMESTAMP WHERE id = '$OPTARG' AND end=0; SELECT * FROM tasks WHERE id = '$OPTARG';"
      ;;
    h|*)
	usage
      ;;
  esac
done

if [[ ! -z "$name" && ! -z "$des" ]]; then
	sqlite3 -line ~/$db "INSERT INTO tasks (name,comment) VALUES ('$name','$des'); SELECT * FROM tasks WHERE id = last_insert_rowid();"
elif [[ -z "$name" && -z "$des" ]]; then
	exit;
else
	echo "You have to set value for both name and description"
fi

